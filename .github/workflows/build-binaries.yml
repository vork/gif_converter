name: Build & Package App

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-binaries.yml'
      - 'lib/**'
      - 'pubspec.yaml'
      - 'macos/**'
      - 'linux/**'
      - 'windows/**'

# ──────────────────────────────────────────────────────────────────────
# Pinned versions — update these when upgrading
# ──────────────────────────────────────────────────────────────────────
env:
  FFMPEG_VERSION: "7.1.1"
  FFMPEG_TARBALL_SHA256: "733984395e0dbbe5c046abda2dc49a5544e7e0e1e2366bba849222ae9e3a03b1"
  GIFSICLE_VERSION: "1.96"
  GIFSICLE_TAG: "v1.96"
  FLUTTER_VERSION: "3.32.0"

jobs:
  # ════════════════════════════════════════════════════════════════════
  # macOS  (arm64 on macos-14, x86_64 on macos-13)
  # ════════════════════════════════════════════════════════════════════
  build-macos:
    strategy:
      matrix:
        include:
          - runner: macos-14
            arch: arm64
          - runner: macos-13
            arch: x86_64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      # ── System deps ──────────────────────────────────────────────
      - name: Install build dependencies
        run: brew install nasm automake autoconf libtool pkg-config

      # ── ffmpeg from source ───────────────────────────────────────
      - name: Download & verify ffmpeg source
        run: |
          curl -L -o ffmpeg.tar.xz "https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VERSION}.tar.xz"
          echo "${FFMPEG_TARBALL_SHA256}  ffmpeg.tar.xz" | shasum -a 256 -c -
          tar xf ffmpeg.tar.xz

      - name: Build ffmpeg (LGPL, static, minimal)
        run: |
          cd ffmpeg-${FFMPEG_VERSION}
          ./configure \
            --prefix="$(pwd)/../ffmpeg-install" \
            --disable-doc --disable-htmlpages --disable-manpages \
            --disable-podpages --disable-txtpages \
            --disable-network --disable-autodetect \
            --disable-programs --enable-ffmpeg \
            --enable-static --disable-shared \
            --disable-debug --enable-small \
            --disable-encoders --enable-encoder=gif --enable-encoder=png \
            --disable-decoders \
            --enable-decoder=h264 --enable-decoder=hevc \
            --enable-decoder=vp8 --enable-decoder=vp9 --enable-decoder=av1 \
            --enable-decoder=mpeg4 --enable-decoder=mpeg2video \
            --enable-decoder=mjpeg --enable-decoder=gif --enable-decoder=png \
            --enable-decoder=rawvideo --enable-decoder=webp \
            --enable-decoder=prores --enable-decoder=dnxhd \
            --enable-decoder=aac --enable-decoder=mp3 \
            --disable-muxers --enable-muxer=gif --enable-muxer=image2 --enable-muxer=null \
            --disable-demuxers \
            --enable-demuxer=mov --enable-demuxer=matroska --enable-demuxer=avi \
            --enable-demuxer=gif --enable-demuxer=image2 \
            --enable-demuxer=mpegts --enable-demuxer=mpegvideo \
            --enable-demuxer=concat --enable-demuxer=webm_dash_manifest \
            --disable-filters \
            --enable-filter=fps --enable-filter=scale \
            --enable-filter=palettegen --enable-filter=paletteuse \
            --enable-filter=split --enable-filter=null --enable-filter=format \
            --enable-filter=setpts --enable-filter=trim --enable-filter=select \
            --enable-filter=color --enable-filter=overlay --enable-filter=concat \
            --disable-protocols --enable-protocol=file --enable-protocol=pipe \
            --disable-bsfs --disable-devices --disable-hwaccels \
            --extra-cflags="-O2"
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Verify ffmpeg
        run: |
          ./ffmpeg-install/bin/ffmpeg -version
          file ./ffmpeg-install/bin/ffmpeg

      # ── gifsicle from source ─────────────────────────────────────
      - name: Clone & build gifsicle
        run: |
          git clone --depth 1 --branch "${GIFSICLE_TAG}" https://github.com/kohler/gifsicle.git
          cd gifsicle
          autoreconf -i
          ./configure --disable-gifview
          make -j$(sysctl -n hw.ncpu)
          ./src/gifsicle --version

      # ── Binary checksums ─────────────────────────────────────────
      - name: Compute binary checksums
        run: |
          mkdir -p binary-out
          cp ffmpeg-install/bin/ffmpeg binary-out/ffmpeg
          cp gifsicle/src/gifsicle binary-out/gifsicle
          chmod +x binary-out/*
          cd binary-out && shasum -a 256 ffmpeg gifsicle | tee checksums.sha256

      - name: Archive gifsicle source (GPL compliance)
        run: tar czf binary-out/gifsicle-${GIFSICLE_VERSION}-source.tar.gz -C gifsicle .

      - uses: actions/upload-artifact@v4
        with:
          name: binaries-macos-${{ matrix.arch }}
          path: binary-out/

      # ── Flutter app build ────────────────────────────────────────
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Place binaries for macOS bundle
        run: |
          mkdir -p macos/Runner/Resources
          cp ffmpeg-install/bin/ffmpeg macos/Runner/Resources/ffmpeg
          cp gifsicle/src/gifsicle macos/Runner/Resources/gifsicle
          chmod +x macos/Runner/Resources/ffmpeg macos/Runner/Resources/gifsicle

      - name: Build macOS app
        run: flutter build macos --release

      - name: Package macOS app
        run: |
          cd build/macos/Build/Products/Release
          # Verify binaries made it into the bundle
          ls -la GifDrop.app/Contents/Resources/ffmpeg \
                 GifDrop.app/Contents/Resources/gifsicle
          GifDrop.app/Contents/Resources/ffmpeg -version 2>&1 | head -1
          GifDrop.app/Contents/Resources/gifsicle --version 2>&1 | head -1
          # Create distributable zip
          ditto -c -k --sequesterRsrc --keepParent GifDrop.app \
                GifDrop-macos-${{ matrix.arch }}.zip

      - uses: actions/upload-artifact@v4
        with:
          name: app-macos-${{ matrix.arch }}
          path: build/macos/Build/Products/Release/GifDrop-macos-${{ matrix.arch }}.zip

  # ════════════════════════════════════════════════════════════════════
  # Linux x86_64
  # ════════════════════════════════════════════════════════════════════
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      # ── System deps ──────────────────────────────────────────────
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm build-essential autoconf automake \
            libtool pkg-config libgtk-3-dev ninja-build \
            clang cmake libblkid-dev liblzma-dev

      # ── ffmpeg from source ───────────────────────────────────────
      - name: Download & verify ffmpeg source
        run: |
          curl -L -o ffmpeg.tar.xz "https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VERSION}.tar.xz"
          echo "${FFMPEG_TARBALL_SHA256}  ffmpeg.tar.xz" | sha256sum -c -
          tar xf ffmpeg.tar.xz

      - name: Build ffmpeg (LGPL, static, minimal)
        run: |
          cd ffmpeg-${FFMPEG_VERSION}
          ./configure \
            --prefix="$(pwd)/../ffmpeg-install" \
            --disable-doc --disable-htmlpages --disable-manpages \
            --disable-podpages --disable-txtpages \
            --disable-network --disable-autodetect \
            --disable-programs --enable-ffmpeg \
            --enable-static --disable-shared \
            --disable-debug --enable-small \
            --extra-ldflags="-static" --pkg-config-flags="--static" \
            --disable-encoders --enable-encoder=gif --enable-encoder=png \
            --disable-decoders \
            --enable-decoder=h264 --enable-decoder=hevc \
            --enable-decoder=vp8 --enable-decoder=vp9 --enable-decoder=av1 \
            --enable-decoder=mpeg4 --enable-decoder=mpeg2video \
            --enable-decoder=mjpeg --enable-decoder=gif --enable-decoder=png \
            --enable-decoder=rawvideo --enable-decoder=webp \
            --enable-decoder=prores --enable-decoder=dnxhd \
            --enable-decoder=aac --enable-decoder=mp3 \
            --disable-muxers --enable-muxer=gif --enable-muxer=image2 --enable-muxer=null \
            --disable-demuxers \
            --enable-demuxer=mov --enable-demuxer=matroska --enable-demuxer=avi \
            --enable-demuxer=gif --enable-demuxer=image2 \
            --enable-demuxer=mpegts --enable-demuxer=mpegvideo \
            --enable-demuxer=concat --enable-demuxer=webm_dash_manifest \
            --disable-filters \
            --enable-filter=fps --enable-filter=scale \
            --enable-filter=palettegen --enable-filter=paletteuse \
            --enable-filter=split --enable-filter=null --enable-filter=format \
            --enable-filter=setpts --enable-filter=trim --enable-filter=select \
            --enable-filter=color --enable-filter=overlay --enable-filter=concat \
            --disable-protocols --enable-protocol=file --enable-protocol=pipe \
            --disable-bsfs --disable-devices --disable-hwaccels \
            --extra-cflags="-O2"
          make -j$(nproc)
          make install

      - name: Verify ffmpeg
        run: |
          ./ffmpeg-install/bin/ffmpeg -version
          file ./ffmpeg-install/bin/ffmpeg
          ldd ./ffmpeg-install/bin/ffmpeg || echo "(static binary)"

      # ── gifsicle from source ─────────────────────────────────────
      - name: Clone & build gifsicle
        run: |
          git clone --depth 1 --branch "${GIFSICLE_TAG}" https://github.com/kohler/gifsicle.git
          cd gifsicle
          autoreconf -i
          ./configure --disable-gifview LDFLAGS="-static"
          make -j$(nproc)
          ./src/gifsicle --version

      # ── Binary checksums ─────────────────────────────────────────
      - name: Compute binary checksums
        run: |
          mkdir -p binary-out
          cp ffmpeg-install/bin/ffmpeg binary-out/ffmpeg
          cp gifsicle/src/gifsicle binary-out/gifsicle
          chmod +x binary-out/*
          cd binary-out && sha256sum ffmpeg gifsicle | tee checksums.sha256

      - name: Archive gifsicle source (GPL compliance)
        run: tar czf binary-out/gifsicle-${GIFSICLE_VERSION}-source.tar.gz -C gifsicle .

      - uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-x86_64
          path: binary-out/

      # ── Flutter app build ────────────────────────────────────────
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Build Linux app
        run: flutter build linux --release

      - name: Inject binaries into Linux bundle
        run: |
          BUNDLE="build/linux/x64/release/bundle"
          # BinaryResolver looks for <exec>/lib/{ffmpeg,gifsicle}
          cp ffmpeg-install/bin/ffmpeg "${BUNDLE}/lib/ffmpeg"
          cp gifsicle/src/gifsicle    "${BUNDLE}/lib/gifsicle"
          chmod +x "${BUNDLE}/lib/ffmpeg" "${BUNDLE}/lib/gifsicle"
          # Verify
          "${BUNDLE}/lib/ffmpeg" -version 2>&1 | head -1
          "${BUNDLE}/lib/gifsicle" --version 2>&1 | head -1

      - name: Package Linux app
        run: |
          cd build/linux/x64/release
          tar czf GifDrop-linux-x86_64.tar.gz -C bundle .

      - uses: actions/upload-artifact@v4
        with:
          name: app-linux-x86_64
          path: build/linux/x64/release/GifDrop-linux-x86_64.tar.gz

  # ════════════════════════════════════════════════════════════════════
  # Windows x86_64  (MSYS2 for native deps, PowerShell for Flutter)
  # ════════════════════════════════════════════════════════════════════
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # ── Build ffmpeg + gifsicle in MSYS2 ─────────────────────────
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            autoconf automake libtool make pkg-config
            tar git diffutils

      - name: Download & verify ffmpeg source
        shell: msys2 {0}
        run: |
          curl -L -o ffmpeg.tar.xz "https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VERSION}.tar.xz"
          echo "${FFMPEG_TARBALL_SHA256}  ffmpeg.tar.xz" | sha256sum -c -
          tar xf ffmpeg.tar.xz

      - name: Build ffmpeg (LGPL, static, minimal)
        shell: msys2 {0}
        run: |
          cd ffmpeg-${FFMPEG_VERSION}
          ./configure \
            --prefix="$(pwd)/../ffmpeg-install" \
            --target-os=mingw32 \
            --disable-doc --disable-htmlpages --disable-manpages \
            --disable-podpages --disable-txtpages \
            --disable-network --disable-autodetect \
            --disable-programs --enable-ffmpeg \
            --enable-static --disable-shared \
            --disable-debug --enable-small \
            --extra-ldflags="-static" --pkg-config-flags="--static" \
            --disable-encoders --enable-encoder=gif --enable-encoder=png \
            --disable-decoders \
            --enable-decoder=h264 --enable-decoder=hevc \
            --enable-decoder=vp8 --enable-decoder=vp9 --enable-decoder=av1 \
            --enable-decoder=mpeg4 --enable-decoder=mpeg2video \
            --enable-decoder=mjpeg --enable-decoder=gif --enable-decoder=png \
            --enable-decoder=rawvideo --enable-decoder=webp \
            --enable-decoder=prores --enable-decoder=dnxhd \
            --enable-decoder=aac --enable-decoder=mp3 \
            --disable-muxers --enable-muxer=gif --enable-muxer=image2 --enable-muxer=null \
            --disable-demuxers \
            --enable-demuxer=mov --enable-demuxer=matroska --enable-demuxer=avi \
            --enable-demuxer=gif --enable-demuxer=image2 \
            --enable-demuxer=mpegts --enable-demuxer=mpegvideo \
            --enable-demuxer=concat --enable-demuxer=webm_dash_manifest \
            --disable-filters \
            --enable-filter=fps --enable-filter=scale \
            --enable-filter=palettegen --enable-filter=paletteuse \
            --enable-filter=split --enable-filter=null --enable-filter=format \
            --enable-filter=setpts --enable-filter=trim --enable-filter=select \
            --enable-filter=color --enable-filter=overlay --enable-filter=concat \
            --disable-protocols --enable-protocol=file --enable-protocol=pipe \
            --disable-bsfs --disable-devices --disable-hwaccels \
            --extra-cflags="-O2"
          make -j$(nproc)
          make install

      - name: Verify ffmpeg
        shell: msys2 {0}
        run: ./ffmpeg-install/bin/ffmpeg.exe -version

      - name: Clone & build gifsicle
        shell: msys2 {0}
        run: |
          git clone --depth 1 --branch "${GIFSICLE_TAG}" https://github.com/kohler/gifsicle.git
          cd gifsicle
          autoreconf -i
          ./configure --disable-gifview
          make -j$(nproc)
          ./src/gifsicle.exe --version

      - name: Compute binary checksums
        shell: msys2 {0}
        run: |
          mkdir -p binary-out
          cp ffmpeg-install/bin/ffmpeg.exe binary-out/ffmpeg.exe
          cp gifsicle/src/gifsicle.exe binary-out/gifsicle.exe
          cd binary-out && sha256sum ffmpeg.exe gifsicle.exe | tee checksums.sha256

      - name: Archive gifsicle source (GPL compliance)
        shell: msys2 {0}
        run: tar czf binary-out/gifsicle-${GIFSICLE_VERSION}-source.tar.gz -C gifsicle .

      - uses: actions/upload-artifact@v4
        with:
          name: binaries-windows-x86_64
          path: binary-out/

      # ── Flutter app build (PowerShell) ───────────────────────────
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Build Windows app
        run: flutter build windows --release

      - name: Inject binaries into Windows bundle
        shell: pwsh
        run: |
          $bundle = "build\windows\x64\runner\Release"
          # BinaryResolver looks for <exec>\data\{ffmpeg.exe,gifsicle.exe}
          New-Item -ItemType Directory -Force -Path "$bundle\data" | Out-Null
          Copy-Item "ffmpeg-install\bin\ffmpeg.exe" "$bundle\data\ffmpeg.exe"
          Copy-Item "gifsicle\src\gifsicle.exe"     "$bundle\data\gifsicle.exe"
          # Verify
          & "$bundle\data\ffmpeg.exe" -version 2>&1 | Select-Object -First 1
          & "$bundle\data\gifsicle.exe" --version 2>&1 | Select-Object -First 1

      - name: Package Windows app
        shell: pwsh
        run: |
          $bundle = "build\windows\x64\runner\Release"
          Compress-Archive -Path "$bundle\*" -DestinationPath "GifDrop-windows-x86_64.zip"

      - uses: actions/upload-artifact@v4
        with:
          name: app-windows-x86_64
          path: GifDrop-windows-x86_64.zip
